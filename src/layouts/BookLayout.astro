---
import { type BookSchema } from "../content/config";
import BaseLayout from "./BaseLayout.astro";
import dayjs from "dayjs";
import localizedFormat from "dayjs/plugin/localizedFormat";
import { Image } from "astro:assets";

export interface Props extends BookSchema {
  slug?: string;
}

const { 
  title, 
  description, 
  authors, 
  translators, 
  publisher, 
  pubDate, 
  url, 
  asin,
  heroImage, 
  status, 
  regDate, 
  beginDate, 
  endDate, 
  badge, 
  tags = [],
  slug,
} = Astro.props;

// 空文字列をundefinedとして解釈
const normalizeEmpty = (value) => !value || value === "" ? undefined : value;
const normalizedHeroImage = normalizeEmpty(heroImage);
const normalizedBeginDate = normalizeEmpty(beginDate);
const normalizedEndDate = normalizeEmpty(endDate);

const R2_DOMAIN = "https://assets.nasu.uk";
// 画像URLを正規化するロジック
const getImageUrl = (path) => {
  if (!path) return path;
  if (path.startsWith("http")) return path;
  // 先頭に / があるかないか吸収して結合
  return `${R2_DOMAIN}/${path.replace(/^\//, '')}`;
};
const displayHeroImage = getImageUrl(normalizedHeroImage);

// 著者・翻訳者をフォーマットする関数
// 配列の場合は "、" で結合する
const formatPersonNames = (value: string | string[] | undefined) => {
  if (!value) return null;
  return Array.isArray(value) ? value.join("、") : value;
};
const displayAuthors = formatPersonNames(authors);
const displayTranslators = formatPersonNames(translators);

const badges = Array.isArray(badge) ? badge.flat() : [badge];
dayjs.extend(localizedFormat);
const displayPubDate = dayjs(pubDate).format("YYYY年MM月DD日");

// 読み始めと読み終わりの期間を表示するフォーマット
const getDateRange = () => {
  if (!normalizedBeginDate) return null;
  // endがない場合は「読書中」とするか、beginのみ表示するかはお好みで調整
  const begin = dayjs(normalizedBeginDate).format("YYYY年MM月DD日");
  const end = normalizedEndDate ? dayjs(normalizedEndDate).format("YYYY年MM月DD日") : "読書中";
  return `${begin} ～ ${end}`;
};

// ★Amazonリンク作成ロジック
// asinがある場合は直リンク(/dp/ASIN)、ない場合はタイトル検索(/s?k=タイトル)
const amazonUrl = asin
  ? `https://www.amazon.co.jp/dp/${asin}` 
  : `https://www.amazon.co.jp/s?k=${encodeURIComponent(title)}`;

// ステータス・バッジの内容によって色を変えるロジック
const getStatusClass = (text) => {
  if (text === "積読") return "badge-info";
  if (text === "読書中") return "badge-warning";
  if (text === "読了") return "badge-success";
  if (text === "挫折") return "badge-error";
  return "badge-secondary";
};

const getBadgeClass = (text) => {
  if (text === "おすすめ") return "badge-info";
  if (text === "難しい") return "badge-warning";
  if (text === "必読") return "badge-success";
  return "badge-secondary";
};
---

<BaseLayout title={title} description={description} image={normalizedHeroImage} ogType="article">
  <main class="md:flex md:justify-center px-4">
    <article class="prose prose-lg w-full max-w-[900px]">
      
      {/* --- ヘッダーエリア（画像と情報の横並び部分） --- */}
      {/* not-prose を指定して、proseのデフォルトスタイル（マージン等）を無効化し、レイアウトを制御しやすくする */}
      <div class="not-prose flex flex-col md:flex-row gap-8 items-start mb-8 border-b pb-8 border-base-300">
        
        {/* 左カラム：画像 */}
        {normalizedHeroImage && (
          <div class="w-full md:w-1/3 flex-shrink-0 flex justify-center md:justify-start">
            <Image 
              width={500} 
              height={700} 
              format="webp" 
              src={displayHeroImage} 
              alt={title} 
              class="rounded-lg shadow-xl w-[200px] md:w-full object-cover aspect-[2/3]" 
            />
          </div>
        )}

        {/* 右カラム：書誌情報 */}
        <div class="w-full md:w-2/3 flex flex-col gap-3">
          
          {/* タイトルとステータス */}
          <div>
            <div class="flex flex-wrap items-center gap-2 mb-2">
              {status && <span class={`badge ${getStatusClass(status)}`}>{status}</span>}
              {badges && 
                badges.filter(Boolean).map((b) => (
                  <span class={`badge ${getBadgeClass(b)}`}>{b}</span>
                ))
              }
            </div>
            <h1 class="text-3xl md:text-4xl font-bold leading-tight text-base-content">{title}</h1>
          </div>

          {/* 著者・翻訳者 */}
          <div class="text-lg font-medium text-base-content/80 leading-relaxed">
            {displayAuthors} <span class="text-sm opacity-70">著</span>
            {displayTranslators && (
              <>
                <span class="mx-2 text-base-content/30">/</span>
                {displayTranslators} <span class="text-sm opacity-70"> 訳</span>
              </>
            )}
          </div>

          {/* 出版社・出版日 */}
          <div class="text-sm text-base-content/70">
            {publisher && <span class="font-semibold">{publisher}</span>}
            {publisher && pubDate && <span class="mx-2">|</span>}
            {pubDate && (<time>{displayPubDate}</time> <span>出版</span>)}
          </div>

          <div class="text-sm text-base-content/70">
            {description && <span>{description}</span>}
          </div>

          {/* 読書期間 */}
          {getDateRange() && (
            <div class="text-sm bg-base-200/50 p-2 rounded-md inline-block self-start">
            読書期間: {getDateRange()}
            </div>
          )}

          {/* タグ */}
          {tags && tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mt-1">
              {tags.map((tag) => (
                <a href={`/books/tag/${tag}`} class="badge badge-outline hover:bg-base-200 transition-colors no-underline">
                  # {tag}
                </a>
              ))}
            </div>
          )}

          {/* アクションボタン（Amazon等） */}
          <div class="flex flex-wrap gap-3 mt-4 pt-4 border-t border-base-200">
            {url && (
              <a href={url} target="_blank" class="btn btn-primary btn-sm">
                出版社のページ
              </a>
            )}
            <a href={amazonUrl} target="_blank" class="btn btn-accent btn-sm">
              Amazonで購入する
            </a>
          </div>

        </div>
      </div>

      {/* --- 本文（感想）エリア --- */}
      {/* ここからは prose が適用される */}
      <div class="prose-img:rounded-xl prose-img:shadow-lg">
        <slot />
      </div>

    </article>
  </main>
</BaseLayout>
